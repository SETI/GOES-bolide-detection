.. _validation_of_detections:

.. sectionauthor:: Jeffrey C. Smith <jsmith@seti.org>

Bolide Validation
=================

Automated Validation
--------------------

Bolide candidates can be either manually assessed by a human using a web interface or automatically. To minimize the effort of
the human vetters and increase consistency, and automated validator has been developed.

If the validation is to be performed automatically then the trained validation model pickle file must be provided. Also, the cutout tool must
be enabled and multi-band data must be generated. This means `cutout_enabled = True` and
`cutout_generate_multi_band_data = True` in the elemental configuration file.

If the validation is successful, then the detection figures are modified to show the assessment of the automated validation.

Validation Configuration File
-----------------------------

The configuration file for validation is specified in the top level configuration file with the parameter
`validationConfigFile`. The output path for the validation reports is set by `reportOutputDir` in the top level configuration file. 
See the section on the :ref:`top level configuration file<top_level_config_file>` for details on the top level configuration file.
Below is a description of the validation configuration file entries:

* **verbosity** : bool
    Whether to be verbose and print diagnostic information.
* **reportEnabled** : bool
    If True then generate the Bolide Detection Validation Report PDF.
* **output_path** : str
    Where to save the generated validation PDFs. 
    Set to None (or do not include) to use the `outputDir` in the top level configuration file.
* **reportCopyIndivFiles** : bool
        If True, then create a subdirectory called `indiv_files` to copy over the individual files for manual inspection.
* **report_create_symlinks** : bool
    If True then the files in the `indiv_files` folder are symlinks.
* **validation_model_path** : str
    Path to the validation model pickle file generated by `bolide_cnn.cnnTrainer.save_best_checkpoint_and_model`.
    Set to None to disable validation.
* **validation_image_cache_path** : str
    Where to temporarily store the cutout image files used for validation for fast access.
    Default = `/tmp/ramdisk/cnn_image_cache`
* **gpu_index** : int
    Specify the GPU index to use for validation assessment.
    Only useful for a multi-GPU machine.
    If None then use default for CUDA.
    If no GPUs are present then the CPU is used, irrespective of this value.
* **delete_image_pickle_files** : bool
    If True then delete the cutout image pickle files after the validation assessment is performed.
    These are large files, several megabytes per candidate.
* **validation_low_threshold** : float [0.0, 1.0]
    The low threshold for the auto-validator. Detections equal or above this threshold are declared candidates.
* **validation_high_threshold** : float [0.0, 1.0]
    The high threshold for the auto-validator. Detections equal or above this threshold are accepted by the validator as
    a "confirmed" candidate to be automatically published on the website.
* **min_num_groups_to_force_candidacy** : int Range:[0:inf]
    The minimum group count a cluster must have to be forced to assessed as a candidate andnot rejected.
    This is intended to force candidates that pass triage with high group count to be forced a candidate.
    Any that pass the higher threshold remain declared as "accepted".
    If this value is not set then it is set to the value **min_num_groups_to_force_candidacy** in the 
    :ref:`elemental configuration file<elemental_config_file>`.

Bolide Detection Validation Report PDF
--------------------------------------

Bolide detection validation is performed before posting on the public website, https://neo-bolide.ndc.nasa.gov/.
This is a combination of manual and automatic inspection using inspection of a collection of PNG figures. 
There are several main figures:

1. Pipeline Detection figure

2. ABI Cutout figure

3. Other satellite detection figure

4. Stereo analysis figure

5. Post-Detection analysis figures

See the :ref:`examining the results<examining_the_results>` page for details on these figures.

The detection and cutout figures are merged side-by-side into a single figure. Then the merged figure and other figures are combined into a 
single PDF validation report.
The report is enabled with the parameter `reportEnabled` in the validation configuration file. The path to place the report is set by `reportOutputDir` 
in the top level configuration file.

Individual Data Files Validation
--------------------------------

The "old" method to review the bolide candidates is to review the individual PNG files for the detection, cutout and
stereo analysis. This method involves manually copying over the individual files and raw netCDF files to a local
machine, reviewing and then manually entering the bolide information into a web form to add the bolide to the official
website. The individual files are located here: ::

    public/GLM_bolide_detections/YYYY/MMDD/indiv_files

To enable this method set the following configuration parameters.

In the top level config file, set: ::

    reportOutputDir = <top_path>/public/GLM_bolide_detections
    deleteDailyExtraFigures = False
    deleteDailyNetCdfFiles = False

In the elemental config file, set: ::

    copyNetCDFFiles = True
    createSymlinks = True or False

In the validation config file, set: ::

    reportEnabled = True
    reportCopyIndivFiles = True
    report_create_symlinks = True or False

Packaged detections were previously made available on a NAS web interface where the human vetter can then peruse the
packaged figures. This NAS Data Portal is currently down with no plans to bring it back up. This means detection
candidates need to be pulled from the NAS filesystem individually.  Vetters are encouraged to use the consolidated
detection validation report PDF. However, if a vetter does not wish to make any changes to their routine or have any
interest in the post-processing figures, the individual detection files can also stored in a subdirectory called
`indiv_files` within each day's validation report directory. 

